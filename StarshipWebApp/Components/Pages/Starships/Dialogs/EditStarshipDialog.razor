@page "/starships/edit/{Id:int}"
@using Radzen
@using Radzen.Blazor
@using StarshipWebApp.Data
@using StarshipWebApp.Models
@using Microsoft.EntityFrameworkCore
@rendermode InteractiveServer
@inject NavigationManager NavigationManager
@inject StarWarsContext DbContext
@inject Radzen.DialogService RadzenDialogService

<PageTitle>Starship Editor</PageTitle>

<RadzenBadge Text="Unsaved Changes" BadgeStyle="BadgeStyle.Success" Variant="Variant.Filled" Visible="_isDirty" />

<RadzenTemplateForm Data="@starship" TItem="Starship" Submit="@OnSubmit">
    <ChildContent>
        <RadzenCard>
            <RadzenRow>
                <!-- Left Column -->
                <RadzenColumn Width="50%">
                    <RadzenFieldset Text="Basic Starship Details">
                        <RadzenLabel Text="Name" />
                        <RadzenTextBox @bind-Value="starship.Name" Change="OnChange" Style="width:100%" Name="Name" />

                        <RadzenLabel Text="Model" />
                        <RadzenTextBox @bind-Value="starship.Model" Change="OnChange" Style="width:100%" Name="Model" />

                        <RadzenLabel Text="Manufacturer" />
                        <RadzenTextBox @bind-Value="starship.Manufacturer" Change="OnChange" Style="width:100%" Name="Manufacturer" />

                        <RadzenLabel Text="Starship Class" />
                        <RadzenAutoComplete Data="@_starshipClasses"
                                            @bind-Value="starship.StarshipClass"
                                            Placeholder="Select or type class"
                                            FilterOperator="StringFilterOperator.Contains"
                                            AllowCustom="true"
                                            Change="@(args => OnChange(args))"
                                            Style="width:100%"
                                            Name="StarshipClass" />
                    </RadzenFieldset>

                    <RadzenFieldset Text="Crew & Passenger Info" Style="margin-top: 20px;">
                        <RadzenLabel Text="Crew" />
                        <RadzenTextBox @bind-Value="starship.Crew" Change="OnChange" Style="width:100%" Name="Crew" />

                        <RadzenLabel Text="Passengers" />
                        <RadzenNumeric @bind-Value="starship.Passengers" Change="@((int? value) => OnChange(value))" Name="Passengers" Style="width:100%" />
                    </RadzenFieldset>
                </RadzenColumn>

                <!-- Right Column -->
                <RadzenColumn Width="50%">
                    <RadzenFieldset Text="Performance Specs">
                        <RadzenLabel Text="Max Speed (Atmospheric)" />
                        <RadzenNumeric @bind-Value="starship.MaxAtmospheringSpeed" Change="@((int? value) => OnChange(value))" Name="MaxAtmospheringSpeed" Style="width:100%" />

                        <RadzenLabel Text="Hyperdrive Rating" />
                        <RadzenNumeric @bind-Value="starship.HyperdriveRating" Change="@((decimal? value) => OnChange(value))" Step="0.01" Name="HyperdriveRating" Style="width:100%" />

                        <RadzenLabel Text="Speed (MGLT)" />
                        <RadzenNumeric @bind-Value="starship.MGLT" Change="@((int? value) => OnChange(value))" Name="MGLT" Style="width:100%" />

                        <RadzenLabel Text="Length (meters)" />
                        <RadzenTextBox @bind-Value="starship.Length" @onchange="OnChange" Style="width:100%" Name="Length" />
                    </RadzenFieldset>

                    <RadzenFieldset Text="Cargo & Capacity" Style="margin-top: 20px;">
                        <RadzenLabel Text="Cost (Credits)" />
                        <RadzenNumeric @bind-Value="starship.CostInCredits" Change="@((long? value) => OnChange(value))" Name="CostInCredits" Style="width:100%" />

                        <RadzenLabel Text="Cargo Capacity (kg)" />
                        <RadzenNumeric @bind-Value="starship.CargoCapacity" Change="@((long? value) => OnChange(value))" Name="CargoCapacity" Style="width:100%" />

                        <RadzenLabel Text="Consumables (Duration)" />
                        <RadzenTextBox @bind-Value="starship.Consumables" @onchange="OnChange" Style="width:100%" Name="Consumables" />
                    </RadzenFieldset>
                </RadzenColumn>
            </RadzenRow>

            <div style="margin-top: 20px;">
                <MudBlazor.MudTooltip Text="@(_isDirty ? "Save Starship changes you have made" : "No Changes have been made to the Starship")" Placement="MudBlazor.Placement.Top" Color="MudBlazor.Color.Info" Arrow="true">
                    <RadzenButton ButtonType="ButtonType.Submit" Text="Save" Icon="save" Style="margin-right: 10px;" Disabled="!_isDirty" />
                </MudBlazor.MudTooltip>

                <RadzenButton Text="Cancel" Click="() => RadzenDialogService.Close(null)" ButtonStyle="ButtonStyle.Secondary" />
            </div>
        </RadzenCard>
    </ChildContent>
</RadzenTemplateForm>

@code {

    [Parameter] public Starship? starship { get; set; } = null;
    private List<string> _starshipClasses = new List<string>();
    private bool _isDirty = false;

    protected override void OnInitialized()
    {
        if (starship == null)
        {
            starship = new Starship();
        }
        _starshipClasses = DbContext.Starships.Select(s => s.StarshipClass).Distinct().ToList();
        _isDirty = false; // Reset dirty state on initialization

        base.OnInitialized();
    }

  

    private async Task OnSubmit()
    {
        starship.UpdatedDate = DateTime.Now;
        DbContext.Update(starship);
        await DbContext.SaveChangesAsync();
        RadzenDialogService.Close(starship);
    }

    private void OnChange(object? value)
    {
        _isDirty = true;
    }

}